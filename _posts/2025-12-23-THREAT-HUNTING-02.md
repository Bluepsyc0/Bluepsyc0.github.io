---
title: "From Software Download to Ransomware Execution"
excerpt: "Threat Hunting"
date: 2025-12-23
categories:
  - Blog
classes: wide custom-report
---
# From Software Download to Ransomware Execution

## Initial Access

- **The user searched Google using these keywords, as shown in the screenshot below.**

   ![Alt text](/assets/images/Threat_hunting_02/initial_access_web_browse.jpg)


- **Reviewing the timeline of the incident, I also found the link that was used for downloading the malicious file.**


   ![Alt text](/assets/images/Threat_hunting_02/Initial_access2_add.jpg)

## Execution

- **After initial access, I wanted to identify which file the user extracted. I associated Event Code 11 (file creation) with the "sharp" keyword I observed from Event Code 15, where the .zip file was downloaded.**

   ![Alt text](/assets/images/Threat_hunting_02/3_execution_setup.jpg)

- **I also noted through correlation between the keyword "world" (taken from the executable) and Event Code 1 (process creation) that the attacker used a legitimate Microsoft build tool in this stage, as shown in the following screenshot.**

   ![Alt text](/assets/images/Threat_hunting_02/4_execution_msbuild.jpg)

## Defense Evasion

- **Reviewing the last behavior generated by rundll32.exe, I suspected DLL injection. Searching by Event Code 8, I found that the attacker injected malicious code into explorer.exe.**

   ![Alt text](/assets/images/Threat_hunting_02/5_defense_evasion_process_inj.jpg)

- **From PowerShell history for the same user, I also found a defense evasion command to disable real-time monitoring, as shown in the next screenshot.**

   ![Alt text](/assets/images/Threat_hunting_02/6_defense_evasion_disablertmon.jpg)

- **I found process injection behavior on the DC as well. The attacker used the same technique observed before.**

   ![Alt text](/assets/images/Threat_hunting_02/9_defense_evasion_process_inj_dc.jpg)

## Persistence

- **To maintain persistence on workstation-01, the attacker created a local user account, as shown in the following screenshot.**

   ![Alt text](/assets/images/Threat_hunting_02/10_persistence_add_local_user.jpg)

- **I also checked workstation-01 for persistence via scheduled tasks. I found a scheduled task that runs a malicious file every time the user logs on.**

   ![Alt text](/assets/images/Threat_hunting_02/11_persistence_scheduled_ws01.jpg)

- **To check for other persistence methods, I searched for WMI using EventCode=19 (Sysmon) and found a new WMI Event Subscription that triggers malicious code whenever the Windows system uptime changes (indicating a reboot or wake event), as shown in the screenshot below.**

   ![Alt text](/assets/images/Threat_hunting_02/12_persistence_wmi_dc.jpg)

- **Another sign of persistence was a new service creation on the file server. Searching by EventCode=4697, I found a malicious service creation (I identified it from the file path commonly used by the attacker), as shown in the following screenshot.**

   ![Alt text](/assets/images/Threat_hunting_02/13_persistence_fs01_service.jpg)

## Credential Access

- **To harvest credentials from ws01, the attacker used rundll32.exe to load a malicious DLL and dump credentials from the lsass process. I also noted the GrantedAccess 0x1010 (GrantedAccess code 0x1010 is the permission Mimikatz uses for the "sekurlsa::logonpasswords" command).**

   ![Alt text](/assets/images/Threat_hunting_02/14_credential_access_ws01.jpg)

## Discovery

- **On the domain controller, I checked all files stored in the path c:\windows\temp, which I had previously seen used by the attacker. Through artifact analysis, I found 2 executables: one recognized as an enumeration tool (AdFind) and syscheck, which I didn't know. I also checked the SIEM and noted some .json files that can be attributed to BloodHound/SharpHound output  as shown in the following screenshots.**

   ![Alt text](/assets/images/Threat_hunting_02/16_discovery_mft_analysis.jpg)


   ![Alt text](/assets/images/Threat_hunting_02/16.1_discovery_sharp_output.jpg)


- **Additionally, after the enumeration phase, the attacker conducted a network scan and checked only specific ports needed to continue the attack, as shown in the following screenshot (timeline - ports) indicating clear network scanning behavior**


   ![Alt text](/assets/images/Threat_hunting_02/17_discovery_scan_port.jpg)

## Command and Control

- **To verify C2 behavior on the first compromised machine, I checked Event Code 3 and process names, along with the frequency of communications, as shown in the following screenshots.**

   ![Alt text](/assets/images/Threat_hunting_02/18_c2_malicious_ip.jpg)


   ![Alt text](/assets/images/Threat_hunting_02/18.1_c2_malicious_ip.jpg)

- **Following the C2 process, I found signs of Cobalt Strike on DC01, including pipe (postex kit) creation, as shown in the following screenshot.**

    ![Alt text](/assets/images/Threat_hunting_02/19_c2_pipe.jpg)

## Collection

- **On fs01, the attacker collected files from different shares, as shown in the following screenshot.**

   ![Alt text](/assets/images/Threat_hunting_02/20_collection_shares.jpg)

## Exfiltration

- **The attacker created a ZIP file and copied it to an external public share with IP 3[.]120[.]129[.]182**

   ![Alt text](/assets/images/Threat_hunting_02/21_exf_zip.jpg)

## Impact

- **Analyzing this incident, I found the ransomware payload. I identified it from readme_decrypt.txt file creation and multiple files targeted by the same process, indicating file encryption. Process name: MammaMia_Marcello.exe, path: \Windows\Temp\MammaMia_Marcello.exe, as shown in the screenshot below.**

   ![Alt text](/assets/images/Threat_hunting_02/22_impact_ransomware_behavior.jpg)

- **Associated with this behavior, ransom note files were created at the same time.**

   ![Alt text](/assets/images/Threat_hunting_02/23_impact_ransom_note.jpg)

- **Hash checked on VirusTotal: 4a2dcb42b807e589d8ccbca5cad4c2b4b7c768caa86d54ff1864065afce0d85b**

   ![Alt text](/assets/images/Threat_hunting_02/24_impact_vt.jpg)

